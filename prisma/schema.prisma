generator client {
  provider = "prisma-client"
  output   = "generated"
}

datasource db {
  provider = "postgresql"
}

model users {
  id                    String                  @id @default(ulid())
  name                  String
  email                 String                  @unique
  emailVerified         Boolean                 @default(false)
  image                 String?
  role                  String?                 @default("user")
  banned                Boolean?                @default(false)
  banReason             String?
  banExpires            DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @default(now()) @updatedAt
  sessions              sessions[]
  accounts              accounts[]
  todos                 todos[]
  syncSettings          syncSettings?
  matters               matters[]
  matterTypeDeadlines   matterTypeDeadlines[]
  paralegalMetrics      paralegalMetrics[]
  editedMatters         matters[]               @relation("editedMatters")
  deadlineNotifications deadlineNotifications[]
  editedContacts        contacts[]              @relation("editedContacts")
  editedMatterTypes     matterTypes[]           @relation("editedMatterTypes")
  notificationSettings  notificationSettings?
}

model sessions {
  id        String   @id @default(ulid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, token])
}

model accounts {
  id                    String    @id @default(ulid())
  accountId             String
  providerId            String
  userId                String
  user                  users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

model verifications {
  id         String   @id @default(ulid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
}

enum TodoStatus {
  pending
  completed
}

model todos {
  id          String     @id @default(ulid())
  title       String
  description String?
  dueTime     DateTime?
  status      TodoStatus @default(pending)
  userId      String
  user        users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model syncSettings {
  id              String    @id @default(ulid())
  userId          String    @unique
  user            users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pollingInterval Int       @default(30)
  lastSyncAt      DateTime?
  isEnabled       Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

enum BillingStatus {
  PAID
  DEPOSIT_PAID
  PAYMENT_PLAN
  DUE
}

model matters {
  id String @id @default(ulid())

  // Docketwise Data (synced)
  docketwiseId        Int       @unique
  docketwiseUpdatedAt DateTime?
  title               String
  matterType          String?
  matterTypeId        Int?
  workflowStage       String?
  workflowStageId     Int?
  clientName          String?
  clientId            Int?
  status              String?
  statusId            Int?
  openedAt            DateTime?
  closedAt            DateTime?
  docketwiseUserIds   String? // JSON array of assigned user IDs from Docketwise

  // Custom Fields (admin editable)
  assignedDate      DateTime?
  estimatedDeadline DateTime?
  actualDeadline    DateTime?
  billingStatus     BillingStatus?
  paralegalAssigned String?
  customNotes       String?

  // Metadata
  lastSyncedAt DateTime @default(now())
  isStale      Boolean  @default(false)

  // Edit Protection & Audit Trail
  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedMatters", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  userId    String
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deadlineNotifications deadlineNotifications[]

  @@index([docketwiseId])
  @@index([userId])
  @@index([assignedDate])
  @@index([estimatedDeadline])
  @@index([isStale])
}

model matterTypeDeadlines {
  id           String   @id @default(ulid())
  matterType   String
  matterTypeId Int?
  deadlineDays Int
  description  String?
  userId       String
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, matterType])
  @@index([userId])
}

model deadlineNotifications {
  id                 String    @id @default(ulid())
  matterId           String
  matter             matters   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  userId             String
  user               users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentAt             DateTime  @default(now())
  recipientEmail     String
  notificationType   String // "email" | "in-app"
  daysBeforeDeadline Int // 7, 3, 1, 0 (on deadline day)
  subject            String
  message            String
  isRead             Boolean   @default(false)
  readAt             DateTime?

  @@index([matterId])
  @@index([userId, isRead])
  @@index([sentAt])
}

model paralegalMetrics {
  id            String   @id @default(ulid())
  paralegalName String
  periodStart   DateTime
  periodEnd     DateTime

  totalMatters        Int    @default(0)
  completedMatters    Int    @default(0)
  staleMatters        Int    @default(0)
  pastDeadlineMatters Int    @default(0)
  avgDaysToFile       Float?
  onTimeFilingRate    Float?

  calculatedAt DateTime @default(now())
  userId       String
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([paralegalName, periodStart])
  @@index([userId])
}

// Docketwise users synced from the API (Team/Paralegals)
model docketwiseUsers {
  id           String   @id @default(ulid())
  docketwiseId Int      @unique
  email        String
  firstName    String?
  lastName     String?
  fullName     String? // Computed: firstName + lastName
  isActive     Boolean  @default(true)
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([docketwiseId])
  @@index([isActive])
}

// Contacts (Clients) - synced from Docketwise with edit protection
model contacts {
  id           String  @id @default(ulid())
  docketwiseId Int     @unique
  firstName    String?
  lastName     String?
  middleName   String?
  companyName  String?
  email        String?
  phone        String?
  type         String? // "Person" or "Institution"
  isLead       Boolean @default(false)

  // Address
  streetAddress   String?
  apartmentNumber String?
  city            String?
  state           String?
  province        String?
  zipCode         String?
  country         String?

  // Custom fields (edit protected)
  customNotes  String?
  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedContacts", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  // Metadata
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([docketwiseId])
  @@index([lastName, firstName])
}

// Immigration Categories (static, admin-managed)
model categories {
  id          String   @id @default(ulid())
  name        String   @unique
  description String?
  color       String? // Hex color for UI
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  matterTypes matterTypes[]
}

// Matter Types - synced from Docketwise with custom fields
model matterTypes {
  id           String @id @default(ulid())
  docketwiseId Int    @unique
  name         String

  // Custom fields (edit protected)
  estimatedDays Int? // Custom: Est. days to complete
  categoryId    String?
  category      categories? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedMatterTypes", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  matterStatuses matterStatuses[]

  @@index([docketwiseId])
  @@index([categoryId])
}

// Matter Statuses (Workflow Stages) - synced from Docketwise
model matterStatuses {
  id           String       @id @default(ulid())
  docketwiseId Int          @unique
  name         String
  duration     Int? // Duration in days (from Docketwise)
  sort         Int? // Sort order
  matterTypeId String?
  matterType   matterTypes? @relation(fields: [matterTypeId], references: [id], onDelete: SetNull)

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([docketwiseId])
  @@index([matterTypeId])
}

// User notification preferences
model notificationSettings {
  id     String @id @default(ulid())
  userId String @unique
  user   users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email notifications
  emailRfe          Boolean @default(true)
  emailApproval     Boolean @default(true)
  emailDenial       Boolean @default(true)
  emailStatusChange Boolean @default(false)
  emailDeadlines    Boolean @default(true)

  // In-app notifications
  inAppRfe          Boolean @default(true)
  inAppApproval     Boolean @default(true)
  inAppDenial       Boolean @default(true)
  inAppStatusChange Boolean @default(true)
  inAppDeadlines    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
