generator client {
  provider = "prisma-client"
  output   = "generated"
}

datasource db {
  provider = "postgresql"
}

model users {
  id                     String                  @id @default(ulid())
  name                   String
  email                  String                  @unique
  emailVerified          Boolean                 @default(false)
  image                  String?
  role                   String?                 @default("user")
  banned                 Boolean?                @default(false)
  banReason              String?
  banExpires             DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @default(now()) @updatedAt
  sessions               sessions[]
  accounts               accounts[]
  todos                  todos[]
  syncSettings           syncSettings?
  matters                matters[]
  matterTypeDeadlines    matterTypeDeadlines[]
  paralegalMetrics       paralegalMetrics[]
  editedMatters          matters[]               @relation("editedMatters")
  deadlineNotifications  deadlineNotifications[]
  editedContacts         contacts[]              @relation("editedContacts")
  editedMatterTypes      matterTypes[]           @relation("editedMatterTypes")
  notificationSettings   notificationSettings?
  notificationRecipients notificationRecipients?
  dashboardStats         dashboardStats?
}

model sessions {
  id        String   @id @default(ulid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, token])
}

model accounts {
  id                    String    @id @default(ulid())
  accountId             String
  providerId            String
  userId                String
  user                  users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

model verifications {
  id         String   @id @default(ulid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
}

enum TodoStatus {
  pending
  completed
}

model todos {
  id          String     @id @default(ulid())
  title       String
  description String?
  dueTime     DateTime?
  status      TodoStatus @default(pending)
  userId      String
  user        users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model syncSettings {
  id                   String    @id @default(ulid())
  userId               String    @unique
  user                 users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pollingInterval      Int       @default(30)
  staleMeasurementDays Int       @default(10) // Days of inactivity before matter is considered stale
  lastSyncAt           DateTime?
  isEnabled            Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
}

enum BillingStatus {
  PAID
  DEPOSIT_PAID
  PAYMENT_PLAN
  DUE
}

model matters {
  id                  String    @id @default(ulid())
  docketwiseId        Int       @unique
  docketwiseNumber    String? // Matter number from Docketwise
  docketwiseCreatedAt DateTime?
  docketwiseUpdatedAt DateTime?
  priorityDate        DateTime? // Priority date from Docketwise
  priorityDateStatus  String? // Priority date status from Docketwise
  title               String
  description         String?
  matterType          String?
  matterTypeId        Int?
  status              String?
  statusId            Int?
  statusForFiling     String?
  statusForFilingId   Int?
  clientName          String?
  clientId            Int?
  teamId              Int? // Foreign key to teams (attorney_id from Docketwise)
  assignee            teams?    @relation("MatterAssignee", fields: [teamId], references: [docketwiseId], onDelete: SetNull)
  assignees           String? // Comma-separated assignee names from user_ids
  docketwiseUserIds   String? // JSON array of user IDs from Docketwise
  openedAt            DateTime?
  closedAt            DateTime?
  archived            Boolean   @default(false) // Whether matter is archived in Docketwise
  discardedAt         DateTime? // When matter was deleted/discarded in Docketwise

  assignedDate      DateTime?
  estimatedDeadline DateTime?
  actualDeadline    DateTime?
  billingStatus     BillingStatus?
  totalHours        Float?
  flatFee           Float? // Flat fee for this specific matter
  customNotes       String?

  // Quality metrics
  rfeCount         Int       @default(0)
  revisionCount    Int       @default(0)
  errorCount       Int       @default(0)
  lastQualityCheck DateTime?

  lastSyncedAt DateTime @default(now())
  isStale      Boolean  @default(false)

  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedMatters", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  userId    String
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deadlineNotifications deadlineNotifications[]

  @@index([docketwiseId])
  @@index([userId])
  @@index([teamId])
  @@index([assignedDate])
  @@index([estimatedDeadline])
  @@index([isStale])
  @@index([status])
  @@index([matterType])
  @@index([clientId])
  @@index([userId, status])
  @@index([userId, teamId])
  @@index([teamId, status])
  @@index([isStale, userId])
  @@index([docketwiseId, userId])
  @@index([archived])
  @@index([userId, archived])
}

model matterTypeDeadlines {
  id           String   @id @default(ulid())
  matterType   String
  matterTypeId Int?
  deadlineDays Int
  description  String?
  userId       String
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, matterType])
  @@index([userId])
}

model deadlineNotifications {
  id                 String    @id @default(ulid())
  matterId           String
  matter             matters   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  userId             String
  user               users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentAt             DateTime  @default(now())
  recipientEmail     String
  notificationType   String
  daysBeforeDeadline Int
  subject            String
  message            String
  isRead             Boolean   @default(false)
  readAt             DateTime?

  @@index([matterId])
  @@index([userId, isRead])
  @@index([sentAt])
}

model paralegalMetrics {
  id            String   @id @default(ulid())
  paralegalName String
  periodStart   DateTime
  periodEnd     DateTime

  totalMatters        Int    @default(0)
  completedMatters    Int    @default(0)
  staleMatters        Int    @default(0)
  pastDeadlineMatters Int    @default(0)
  avgDaysToFile       Float?
  onTimeFilingRate    Float?

  calculatedAt DateTime @default(now())
  userId       String
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([paralegalName, periodStart])
  @@index([userId])
}

model teams {
  id           String  @id @default(ulid())
  docketwiseId Int     @unique
  email        String
  firstName    String?
  lastName     String?
  fullName     String?
  isActive     Boolean @default(true)
  teamType     String  @default("inHouse") // "inHouse" | "contractor"
  title        String? // e.g., "Senior Paralegal", "Attorney"

  // Paralegal capacity settings (nullable for non-paralegals)
  availableHoursPerWeek Float? // e.g., 40, 35, 20
  utilizationTarget     Float? // e.g., 0.75, 0.80 (75%, 80%)
  performanceIndex      Float? // Calculated performance score (0-100)

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  assignedMatters matters[] @relation("MatterAssignee")

  @@index([docketwiseId])
  @@index([isActive])
  @@index([teamType])
  @@index([email])
  @@index([fullName])
  @@index([isActive, teamType])
  @@index([isActive, email])
}

model contacts {
  id           String  @id @default(ulid())
  docketwiseId Int     @unique
  firstName    String?
  lastName     String?
  middleName   String?
  companyName  String?
  email        String?
  phone        String?
  type         String?
  isLead       Boolean @default(false)

  streetAddress   String?
  apartmentNumber String?
  city            String?
  state           String?
  province        String?
  zipCode         String?
  country         String?

  customNotes  String?
  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedContacts", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  // Metadata
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([docketwiseId])
  @@index([lastName, firstName])
}

model categories {
  id          String   @id @default(ulid())
  name        String   @unique
  description String?
  color       String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  matterTypes matterTypes[]
}

model matterTypes {
  id           String @id @default(ulid())
  docketwiseId Int    @unique
  name         String

  estimatedDays    Int?
  complexityWeight Int         @default(1) // 1=simple, 2=medium, 3=complex
  flatFee          Float? // Flat fee for this matter type
  categoryId       String?
  category         categories? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  isEdited     Boolean   @default(false)
  editedBy     String?
  editedByUser users?    @relation("editedMatterTypes", fields: [editedBy], references: [id], onDelete: SetNull)
  editedAt     DateTime?

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  matterStatuses matterStatuses[]

  @@index([docketwiseId])
  @@index([categoryId])
}

model matterStatuses {
  id           String       @id @default(ulid())
  docketwiseId Int          @unique
  name         String
  duration     Int?
  sort         Int?
  matterTypeId String?
  matterType   matterTypes? @relation(fields: [matterTypeId], references: [id], onDelete: SetNull)

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([docketwiseId])
  @@index([matterTypeId])
}

model notificationSettings {
  id     String @id @default(ulid())
  userId String @unique
  user   users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email notifications
  emailRfe          Boolean @default(true)
  emailApproval     Boolean @default(true)
  emailDenial       Boolean @default(true)
  emailStatusChange Boolean @default(false)
  emailDeadlines    Boolean @default(true)

  // In-app notifications
  inAppRfe          Boolean @default(true)
  inAppApproval     Boolean @default(true)
  inAppDenial       Boolean @default(true)
  inAppStatusChange Boolean @default(true)
  inAppDeadlines    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model notificationRecipients {
  id           String  @id @default(ulid())
  userId       String  @unique
  user         users   @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailEnabled Boolean @default(true)
  inAppEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model syncProgress {
  id             String    @id @default(ulid())
  userId         String
  syncType       String // 'matter_details', 'matters', 'contacts', etc.
  lastSyncedId   Int? // Last docketwiseId synced (for resumption)
  lastSyncDate   DateTime? // Date of last successful sync (for daily sync check)
  status         String    @default("idle") // 'idle', 'syncing', 'completed', 'failed'
  failureReason  String? // Reason for failure (e.g., "Rate limit exceeded")
  totalProcessed Int       @default(0)
  totalFailed    Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, syncType])
  @@index([userId, syncType])
  @@index([status])
}

model dashboardStats {
  id     String @id @default(ulid())
  userId String @unique
  user   users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Primary KPIs
  totalMatters        Int @default(0)
  activeMattersCount  Int @default(0)
  newMattersThisMonth Int @default(0)
  criticalMatters     Int @default(0)
  rfeFrequency        Int @default(0)

  // Secondary KPIs
  overdueMatters Int    @default(0)
  avgDaysToFile  Float?
  estRevenue     Float  @default(0)
  unassigned     Int    @default(0)

  // Trends and metrics
  newMattersGrowth       String?
  weightedActiveMatters  Int     @default(0)
  revenueAtRisk          Float   @default(0)
  deadlineComplianceRate Float   @default(0)
  avgCycleTime           Float   @default(0)
  paralegalUtilization   Float   @default(0)
  atRiskMatters          Int     @default(0)
  unassignedMatters      Int     @default(0)
  overloadedParalegals   Int     @default(0)

  // Revenue metrics
  totalRevenue       Float @default(0)
  pendingRevenue     Float @default(0)
  collectedRevenue   Float @default(0)
  averageMatterValue Float @default(0)

  // Performance metrics
  matterVelocity   Float @default(0)
  onTimeRate       Float @default(0)
  teamUtilization  Float @default(0)
  avgRfeRate       Float @default(0)
  totalReworkCount Int   @default(0)
  qualityScore     Float @default(0)

  // Capacity metrics
  totalAvailableHours Float @default(0)
  totalAssignedHours  Float @default(0)
  totalBillableHours  Float @default(0)

  // Trends
  mattersTrend      Int?
  revenueTrend      Int?
  deadlineMissTrend Int?

  // Data quality
  mattersWithoutPricing    Int   @default(0)
  mattersWithoutDeadline   Int   @default(0)
  mattersWithoutMatterType Int   @default(0)
  dataQualityScore         Float @default(100)

  // Basic counts
  totalContacts           Int @default(0)
  totalMatterTypes        Int @default(0)
  teamMembers             Int @default(0)
  categories              Int @default(0)
  activeTeamMembers       Int @default(0)
  matterTypesWithWorkflow Int @default(0)
  editedMatters           Int @default(0)

  // Metadata
  lastSyncedAt DateTime @default(now())
  calculatedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([lastSyncedAt])
}
